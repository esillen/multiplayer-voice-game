<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="~{fragments/header :: head('Voice Calibration')}"></head>
<body>
    <div class="scanlines"></div>
    <div class="container calibrate-container">
        <header th:replace="~{fragments/header :: navbar}"></header>
        
        <main class="calibrate-page">
            <!-- Test Paddle on the left side -->
            <div class="test-paddle-sidebar" id="testPaddleArea">
                <div class="test-paddle-track">
                    <div class="test-paddle" id="testPaddle"></div>
                </div>
                <span class="test-paddle-label">TEST</span>
            </div>
            
            <!-- Main content centered -->
            <div class="calibrate-content">
                <h1 class="page-title">VOICE CALIBRATION</h1>
                
                <!-- Enhanced Pitch Meter with Draggable Thresholds -->
                <div class="pitch-meter-section">
                    <h3>PITCH THRESHOLDS</h3>
                    <div class="pitch-meter-container">
                        <div class="pitch-scale">
                            <span>60 Hz</span>
                            <span>200 Hz</span>
                            <span>350 Hz</span>
                            <span>500 Hz</span>
                        </div>
                        <div class="pitch-meter-bar" id="pitchMeterBar">
                            <!-- Current pitch marker -->
                            <div class="pitch-marker" id="pitchMarker"></div>
                            
                            <!-- Draggable threshold markers -->
                            <div class="threshold-marker high-threshold" id="highThreshold" draggable="true">
                                <div class="threshold-handle"></div>
                                <span class="threshold-label">HIGH</span>
                            </div>
                            <div class="threshold-marker low-threshold" id="lowThreshold" draggable="true">
                                <div class="threshold-handle"></div>
                                <span class="threshold-label">LOW</span>
                            </div>
                            
                            <!-- Zone fills -->
                            <div class="zone-fill low-zone-fill" id="lowZoneFill"></div>
                            <div class="zone-fill high-zone-fill" id="highZoneFill"></div>
                        </div>
                        <div class="zone-labels">
                            <span class="zone-label low">LOW ZONE</span>
                            <span class="zone-label mid">MEDIUM ZONE</span>
                            <span class="zone-label high">HIGH ZONE</span>
                        </div>
                    </div>
                    
                    <div class="current-pitch">
                        <span id="currentFrequency">-- Hz</span>
                        <span id="currentPitchLabel" class="pitch-state">WAITING</span>
                    </div>
                </div>
                
                <!-- Calibration Controls -->
                <div class="calibration-controls">
                    <div class="calibrate-btn-group">
                        <button id="calibrateLow" class="calibrate-btn low">
                            <span class="btn-label">ðŸŽµ CALIBRATE LOW</span>
                            <span class="btn-value" id="lowValue">-- Hz</span>
                            <div class="recording-ring" id="lowRecordingRing"></div>
                        </button>
                        <button id="calibrateHigh" class="calibrate-btn high">
                            <span class="btn-label">ðŸŽµ CALIBRATE HIGH</span>
                            <span class="btn-value" id="highValue">-- Hz</span>
                            <div class="recording-ring" id="highRecordingRing"></div>
                        </button>
                    </div>
                    
                    <p class="calibrate-hint">
                        Click a button and hold your pitch for 2 seconds.<br>
                        Or drag the threshold markers to adjust manually.
                    </p>
                    
                    <div class="threshold-display">
                        <div class="threshold-info low">
                            <span class="label">Low Threshold:</span>
                            <span class="value" id="lowThresholdValue">180 Hz</span>
                        </div>
                        <div class="threshold-info high">
                            <span class="label">High Threshold:</span>
                            <span class="value" id="highThresholdValue">280 Hz</span>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="calibrate-actions">
                    <button id="resetCalibration" class="btn btn-secondary">
                        <span>â†» RESET TO DEFAULTS</span>
                    </button>
                    <a th:href="@{/singleplayer}" class="btn btn-primary">
                        <span>ðŸŽ® PLAY GAME</span>
                    </a>
                </div>
                
                <!-- Advanced Settings Tab -->
                <div class="advanced-section">
                    <button class="advanced-toggle" id="advancedToggle">
                        <span class="toggle-icon">â–¶</span> Advanced Settings
                    </button>
                    
                    <div class="advanced-panel" id="advancedPanel">
                        <div class="advanced-grid">
                            <!-- YIN Algorithm Settings -->
                            <div class="setting-group">
                                <h4>Detection Sensitivity</h4>
                                
                                <div class="setting-row">
                                    <label for="yinThreshold">YIN Threshold</label>
                                    <input type="range" id="yinThreshold" min="0.05" max="0.3" step="0.01" value="0.15">
                                    <span class="setting-value" id="yinThresholdVal">0.15</span>
                                </div>
                                <p class="setting-desc">Lower = stricter pitch detection, higher = more lenient</p>
                                
                                <div class="setting-row">
                                    <label for="probabilityThreshold">Confidence Threshold</label>
                                    <input type="range" id="probabilityThreshold" min="0.3" max="0.95" step="0.05" value="0.70">
                                    <span class="setting-value" id="probabilityThresholdVal">0.70</span>
                                </div>
                                <p class="setting-desc">Minimum confidence to accept a pitch reading</p>
                                
                                <div class="setting-row">
                                    <label for="volumeThreshold">Volume Threshold</label>
                                    <input type="range" id="volumeThreshold" min="0.005" max="0.05" step="0.001" value="0.015">
                                    <span class="setting-value" id="volumeThresholdVal">0.015</span>
                                </div>
                                <p class="setting-desc">Minimum volume to detect voice (vs silence)</p>
                            </div>
                            
                            <!-- Frequency Range -->
                            <div class="setting-group">
                                <h4>Frequency Range</h4>
                                
                                <div class="setting-row">
                                    <label for="minFrequency">Min Frequency (Hz)</label>
                                    <input type="range" id="minFrequency" min="50" max="150" step="5" value="70">
                                    <span class="setting-value" id="minFrequencyVal">70</span>
                                </div>
                                <p class="setting-desc">Lowest detectable pitch (bass voices ~80Hz)</p>
                                
                                <div class="setting-row">
                                    <label for="maxFrequency">Max Frequency (Hz)</label>
                                    <input type="range" id="maxFrequency" min="300" max="800" step="10" value="500">
                                    <span class="setting-value" id="maxFrequencyVal">500</span>
                                </div>
                                <p class="setting-desc">Highest detectable pitch (soprano ~500Hz)</p>
                            </div>
                            
                            <!-- Smoothing Settings -->
                            <div class="setting-group">
                                <h4>Smoothing &amp; Stability</h4>
                                
                                <div class="setting-row">
                                    <label for="smoothingAlpha">Smoothing Factor</label>
                                    <input type="range" id="smoothingAlpha" min="0.1" max="0.9" step="0.05" value="0.50">
                                    <span class="setting-value" id="smoothingAlphaVal">0.50</span>
                                </div>
                                <p class="setting-desc">Higher = more responsive, lower = smoother</p>
                                
                                <div class="setting-row">
                                    <label for="medianFilterSize">Median Filter Size</label>
                                    <input type="range" id="medianFilterSize" min="3" max="9" step="2" value="5">
                                    <span class="setting-value" id="medianFilterSizeVal">5</span>
                                </div>
                                <p class="setting-desc">Frames used for median filtering (odd numbers)</p>
                                
                                <div class="setting-row">
                                    <label for="stabilityFrames">Stability Frames</label>
                                    <input type="range" id="stabilityFrames" min="1" max="5" step="1" value="1">
                                    <span class="setting-value" id="stabilityFramesVal">1</span>
                                </div>
                                <p class="setting-desc">Consistent readings needed before pitch change</p>
                            </div>
                            
                        </div>
                        
                        <div class="advanced-actions">
                            <button id="resetAdvanced" class="btn btn-secondary btn-sm">
                                <span>â†» Reset to Defaults</span>
                            </button>
                            <button id="saveAdvanced" class="btn btn-primary btn-sm">
                                <span>ðŸ’¾ Save Settings</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Main Visualizer Section -->
            <div class="visualizer-section">
                <div class="viz-row">
                    <div class="viz-panel">
                        <h3>SPECTROGRAM</h3>
                        <canvas id="spectrogramCanvas" width="380" height="150"></canvas>
                    </div>
                    <div class="viz-panel">
                        <h3>WAVEFORM</h3>
                        <canvas id="waveformCanvas" width="380" height="150"></canvas>
                    </div>
                </div>
                
                <div class="viz-panel full-width">
                    <h3>FREQUENCY SPECTRUM</h3>
                    <canvas id="frequencyCanvas" width="780" height="100"></canvas>
                </div>
                
                
        </main>
        
        <footer th:replace="~{fragments/footer :: footer}"></footer>
    </div>
    
    <script th:src="@{/js/audio-visualizer.js}"></script>
    <script th:src="@{/js/calibration.js}"></script>
</body>
</html>
